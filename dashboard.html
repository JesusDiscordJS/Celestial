<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Celestial Tracker</title>
    <link rel="stylesheet" href="style.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos adicionais para melhor apresenta칞칚o dos resultados e inputs */
        .dashboard-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
            background-color: #30353b; /* Cor de fundo para o 칤cone padr칚o */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .dashboard-avatar-icon.fa-user-astronaut {
             font-size: 20px; /* Tamanho do 칤cone se a imagem n칚o carregar */
             color: #fff;
        }
        .dashboard-search-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #2c2f33; /* Um pouco mais escuro que o corpo */
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .dashboard-search-area input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #4f545c;
            border-radius: 4px;
            background-color: #40444b;
            color: #dcddde;
        }
        .dashboard-search-area input[type="text"]::placeholder {
            color: #b9bbbe;
        }
        #trackerResults {
            margin-top: 20px;
            padding: 15px;
            background-color: #23272a;
            border-radius: 8px;
            color: #dcddde;
            min-height: 50px;
            white-space: pre-wrap; /* Para formatar JSON de exemplo */
            word-wrap: break-word;
        }
        #trackerResults h4 {
            margin-top: 0;
            color: #7289da; /* Cor do Discord */
        }
        #trackerResults .error {
            color: #f04747; /* Vermelho para erros */
        }
        #trackerResults .success {
            color: #43b581; /* Verde para sucesso */
        }
        .dashboard-user {
            display: flex;
            align-items: center;
        }
        .logout-btn {
            background-color: #f04747; /* Vermelho para logout */
            color: white;
        }
        .logout-btn:hover {
            background-color: #c73b3b;
        }
        /* Melhorias nos bot칫es de a칞칚o */
        .dashboard-actions button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
        }
        .dashboard-actions button:hover {
            transform: translateY(-2px);
        }
        .dashboard-actions button:active {
            transform: translateY(0px);
        }
        .history-entry, .server-entry, .nickname-entry, .avatar-entry, .banner-entry {
            background-color: #2c2f33;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #7289da;
        }
        .history-entry p, .server-entry p, .nickname-entry p, .avatar-entry p, .banner-entry p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        .history-entry strong, .server-entry strong {
            color: #b9bbbe;
        }
        .avatar-list img, .banner-list img {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border-radius: 4px;
            background-color: #23272a;
        }
    </style>
</head>
<body class="dashboard-page-body">
    <div id="dashboardArea">
        <div class="dashboard-header-info">
            <div class="dashboard-user">
                <img src="" alt="Avatar" id="loggedInUserAvatar" class="dashboard-user-avatar" style="display: none;">
                <i id="defaultAvatarIcon" class="fas fa-user-astronaut dashboard-avatar-icon"></i>
                <span id="loggedInUsername" class="dashboard-username">Carregando...</span>
                <span class="dashboard-user-status premium">Premium</span> </div>
            <span class="dashboard-maintenance-notice">游뚾 Plataforma em Manuten칞칚o</span> </div>

        <div class="dashboard-search-area">
            <input type="text" id="userIdToTrack" placeholder="Digite o ID do Usu치rio Discord para rastrear">
            <button id="trackBtn" class="dashboard-btn"><i class="fas fa-search-location"></i> Rastrear</button>
            <button id="clearBtn" class="dashboard-btn dashboard-btn-clear"><i class="fas fa-broom"></i> Limpar</button>
        </div>
        
        <div class="dashboard-actions">
            <button id="trackerPageBtn" class="dashboard-btn"><i class="fas fa-satellite-dish"></i> Tracker</button> <button id="logoutBtn" class="dashboard-btn logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div id="trackerResults">
            <h4>Resultados do Rastreamento:</h4>
            <p>Insira um ID e clique em "Rastrear" para ver os dados.</p>
        </div>

        <main class="dashboard-main-content">
            <h2>Central de Rastreamento Celestial</h2>
            <p>Bem-vindo  sua central de comando. Monitore e analise dados de toda a gal치xia Discord.</p>
            <div class="dashboard-widgets">
                <div class="widget">
                    <i class="fas fa-users widget-icon"></i>
                    <h3>Usu치rios Ativos</h3>
                    <p>1,234</p> </div>
                <div class="widget">
                    <i class="fas fa-eye widget-icon"></i>
                    <h3>Alvos Monitorados</h3>
                    <p>56</p> </div>
                <div class="widget">
                    <i class="fas fa-history widget-icon"></i>
                    <h3>Eventos Recentes</h3>
                    <p>789</p> </div>
                <div class="widget data-stream-widget">
                    <i class="fas fa-wave-square widget-icon"></i>
                    <h3>Fluxo de Dados Gal치ctico</h3>
                    <div class="data-stream-animation">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <p>Conectado ao Supercluster Laniakea...</p> </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://celestial-api.onrender.com';
            // !!! IMPORTANTE: Substitua pela URL real da sua p치gina de login !!!
            const FRONTEND_LOGIN_URL = 'SUA_URL_DE_LOGIN_FRONTEND'; 

            const loggedInUsernameEl = document.getElementById('loggedInUsername');
            const loggedInUserAvatarEl = document.getElementById('loggedInUserAvatar');
            const defaultAvatarIconEl = document.getElementById('defaultAvatarIcon');
            
            const userIdToTrackInput = document.getElementById('userIdToTrack');
            const trackBtn = document.getElementById('trackBtn');
            const clearBtn = document.getElementById('clearBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const trackerResultsEl = document.getElementById('trackerResults');

            // Fun칞칚o para buscar dados da API
            async function fetchData(endpoint, options = {}) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        credentials: 'include', // Essencial para enviar cookies de sess칚o
                        ...options
                    });
                    if (response.status === 401) { // N칚o autorizado
                        window.location.href = FRONTEND_LOGIN_URL;
                        return null; 
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `Erro ${response.status}` }));
                        throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    if (response.headers.get("content-type")?.includes("application/json")) {
                        return await response.json();
                    }
                    return await response.text(); // Para logout que pode n칚o retornar JSON
                } catch (error) {
                    console.error('Fetch error:', error);
                    throw error; // Re-throw para ser pego pelo chamador
                }
            }

            // Verificar autentica칞칚o e buscar dados do usu치rio ao carregar a p치gina
            async function checkAuth() {
                try {
                    const userData = await fetchData('/api/me');
                    if (userData && userData.id) {
                        loggedInUsernameEl.textContent = userData.global_name || userData.username;
                        if (userData.avatar) {
                            const avatarExtension = userData.avatar.startsWith('a_') ? 'gif' : 'png';
                            loggedInUserAvatarEl.src = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.${avatarExtension}?size=40`;
                            loggedInUserAvatarEl.style.display = 'inline-block';
                            defaultAvatarIconEl.style.display = 'none';
                        } else {
                            loggedInUserAvatarEl.style.display = 'none';
                            defaultAvatarIconEl.style.display = 'inline-flex';
                        }
                    }
                } catch (error) {
                    loggedInUsernameEl.textContent = 'N칚o logado';
                    loggedInUserAvatarEl.style.display = 'none';
                    defaultAvatarIconEl.style.display = 'inline-flex';
                    // Se o erro n칚o for 401 (j치 tratado no fetchData), pode mostrar uma mensagem.
                    // O redirecionamento para login j치 acontece em fetchData se for 401.
                    if (error.message && !error.message.includes("401")) {
                        // trackerResultsEl.innerHTML = `<p class="error">Erro ao carregar dados do usu치rio: ${error.message}</p>`;
                        // N칚o queremos poluir os resultados do tracker com erros de auth iniciais se n칚o for 401
                        console.warn("Erro ao buscar /api/me, mas n칚o foi 401:", error.message);
                    }
                }
            }

            // Fun칞칚o para exibir os resultados do rastreamento
            function displayTrackerResults(data) {
                trackerResultsEl.innerHTML = `<h4>Resultados para ${data.username_global || data.user_id}:</h4>`;

                let content = `<p><strong>ID do Usu치rio:</strong> ${data.user_id}</p>`;
                content += `<p><strong>Username Global:</strong> ${data.username_global || 'N/A'}</p>`;
                content += `<p><strong>Registrado em:</strong> ${new Date(data.createdAt).toLocaleString()}</p>`;
                content += `<p><strong>칔ltima Atualiza칞칚o:</strong> ${new Date(data.updatedAt).toLocaleString()}</p>`;

                if (data.avatar_urls && data.avatar_urls.length > 0) {
                    content += `<h5>Avatares (${data.avatar_urls.length}):</h5><div class="avatar-list">`;
                    data.avatar_urls.slice(0, 5).forEach(url => { // Mostra os 칰ltimos 5, por exemplo
                        content += `<a href="${url}" target="_blank"><img src="${url}" alt="Avatar"></a>`;
                    });
                    if (data.avatar_urls.length > 5) content += `<span>... e mais ${data.avatar_urls.length - 5}</span>`;
                    content += `</div>`;
                } else {
                    content += `<p><strong>Avatares:</strong> Nenhum registrado.</p>`;
                }

                if (data.banner_urls && data.banner_urls.length > 0) {
                    content += `<h5>Banners de Perfil (${data.banner_urls.length}):</h5><div class="banner-list">`;
                    data.banner_urls.slice(0, 3).forEach(url => { // Mostra os 칰ltimos 3
                        content += `<a href="${url}" target="_blank"><img src="${url}" alt="Banner"></a>`;
                    });
                    if (data.banner_urls.length > 3) content += `<span>... e mais ${data.banner_urls.length - 3}</span>`;
                    content += `</div>`;
                } else {
                    content += `<p><strong>Banners de Perfil:</strong> Nenhum registrado.</p>`;
                }
                
                if (data.nicknames && data.nicknames.length > 0) {
                    content += `<h5>Nicknames (${data.nicknames.length}):</h5>`;
                    data.nicknames.forEach(nick => {
                        content += `<div class="nickname-entry"><p>${nick}</p></div>`;
                    });
                } else {
                    content += `<p><strong>Nicknames:</strong> Nenhum registrado.</p>`;
                }

                if (data.servers && data.servers.length > 0) {
                    content += `<h5>Servidores em Comum Conhecidos (${data.servers.length}):</h5>`;
                    data.servers.forEach(server => {
                        content += `<div class="server-entry">
                                        <p><strong>${server.guild_name || 'Nome n칚o dispon칤vel'}</strong> (ID: ${server.guild_id})</p>
                                        <p>Visto pela primeira vez: ${new Date(server.first_seen).toLocaleString()}</p>
                                    </div>`;
                    });
                } else {
                    content += `<p><strong>Servidores:</strong> Nenhum servidor em comum registrado.</p>`;
                }

                if (data.history && data.history.length > 0) {
                    content += `<h5>Hist칩rico de Mudan칞as (${data.history.length}):</h5>`;
                    // Mostrar as N entradas mais recentes do hist칩rico
                    const recentHistory = data.history.slice(-5).reverse(); // Pega as 칰ltimas 5 e inverte para mais recente primeiro
                    recentHistory.forEach(entry => {
                        content += `<div class="history-entry">
                                        <p><strong>Data da Mudan칞a:</strong> ${new Date(entry.changed_at).toLocaleString()}</p>`;
                        if (entry.changes.username_global) {
                            content += `<p>Username Global alterado para: ${entry.changes.username_global}</p>`;
                        }
                        if (entry.changes.avatar_url) {
                            content += `<p>Novo Avatar: <a href="${entry.changes.avatar_url}" target="_blank">Ver Avatar</a></p>`;
                        }
                        if (entry.changes.banner_url) {
                            content += `<p>Novo Banner: <a href="${entry.changes.banner_url}" target="_blank">Ver Banner</a></p>`;
                        }
                        if (entry.changes.nickname_added) {
                            content += `<p>Nickname Adicionado: ${entry.changes.nickname_added}</p>`;
                        }
                        if (entry.changes.server_joined) {
                            content += `<p>Entrou no Servidor: ${entry.changes.server_joined.guild_name} (ID: ${entry.changes.server_joined.guild_id})</p>`;
                        }
                        content += `</div>`;
                    });
                     if (data.history.length > 5) content += `<p>... e mais ${data.history.length - 5} entradas no hist칩rico.</p>`;
                } else {
                    content += `<p><strong>Hist칩rico:</strong> Nenhum hist칩rico de mudan칞as registrado.</p>`;
                }
                trackerResultsEl.innerHTML += content;
            }

            // Lidar com clique no bot칚o "Rastrear"
            trackBtn.addEventListener('click', async () => {
                const userId = userIdToTrackInput.value.trim();
                if (!userId) {
                    trackerResultsEl.innerHTML = '<p class="error">Por favor, insira um ID de usu치rio.</p>';
                    return;
                }
                if (!/^\d{17,20}$/.test(userId)) {
                    trackerResultsEl.innerHTML = '<p class="error">Formato de ID de usu치rio inv치lido. Deve conter de 17 a 20 d칤gitos.</p>';
                    return;
                }

                trackerResultsEl.innerHTML = '<p>Buscando dados...</p>';
                try {
                    const trackingData = await fetchData(`/api/avatars/${userId}`);
                    if (trackingData) {
                        displayTrackerResults(trackingData);
                    } else {
                         // Se fetchData retornou null (ex: por causa de um 401 j치 tratado com redirect), 
                         // n칚o precisa mostrar erro aqui, pois o redirect j치 ocorreu.
                         // Se o erro n칚o foi 401, ele teria sido lan칞ado e pego no catch abaixo.
                        if (window.location.href !== FRONTEND_LOGIN_URL) { // Evita mensagem se j치 estiver redirecionando
                            trackerResultsEl.innerHTML = '<p class="error">N칚o foi poss칤vel obter os dados de rastreamento. Verifique o console para mais detalhes.</p>';
                        }
                    }
                } catch (error) {
                    trackerResultsEl.innerHTML = `<p class="error">Erro ao rastrear usu치rio: ${error.message}</p>`;
                }
            });

            // Limpar resultados
            clearBtn.addEventListener('click', () => {
                userIdToTrackInput.value = '';
                trackerResultsEl.innerHTML = `<h4>Resultados do Rastreamento:</h4>
                                             <p>Insira um ID e clique em "Rastrear" para ver os dados.</p>`;
            });
            
            // Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    const logoutResult = await fetchData('/auth/logout', { method: 'GET' }); // GET como definido na API
                    if(logoutResult && logoutResult.message === "Logout bem-sucedido") {
                        // O servidor pode j치 redirecionar ou podemos for칞ar aqui
                         window.location.href = logoutResult.redirectTo || FRONTEND_LOGIN_URL;
                    } else {
                         // Se o servidor n칚o especificou redirectTo, ou a mensagem foi inesperada.
                        window.location.href = FRONTEND_LOGIN_URL;
                    }
                } catch (error) {
                    // Mesmo em erro, tentar redirecionar para o login pode ser uma boa fallback
                    trackerResultsEl.innerHTML = `<p class="error">Erro ao fazer logout: ${error.message}. Redirecionando para login...</p>`;
                    setTimeout(() => { window.location.href = FRONTEND_LOGIN_URL; }, 2000);
                }
            });

            // Inicializar
            checkAuth();
        });
    </script>
</body>
</html>
